var jsPsychAudioKeyboardResponse=function(e){"use strict";const t={name:"audio-keyboard-response",parameters:{stimulus:{type:e.ParameterType.AUDIO,pretty_name:"Stimulus","default":undefined},choices:{type:e.ParameterType.KEYS,pretty_name:"Choices","default":"ALL_KEYS"},prompt:{type:e.ParameterType.HTML_STRING,pretty_name:"Prompt","default":null},trial_duration:{type:e.ParameterType.INT,pretty_name:"Trial duration","default":null},response_ends_trial:{type:e.ParameterType.BOOL,pretty_name:"Response ends trial","default":!0},trial_ends_after_audio:{type:e.ParameterType.BOOL,pretty_name:"Trial ends after audio","default":!1},response_allowed_while_playing:{type:e.ParameterType.BOOL,pretty_name:"Response allowed while playing","default":!0}}};class s{constructor(e){this.jsPsych=e}trial(e,t,s){function i(e){null==r.key&&(r=e),t.response_ends_trial&&u()}let a;var n,l=this.jsPsych.pluginAPI.audioContext(),r={rt:null,key:null};this.jsPsych.pluginAPI.getAudioBuffer(t.stimulus).then(e=>{null!==l?(this.audio=l.createBufferSource(),this.audio.buffer=e,this.audio.connect(l.destination)):(this.audio=e,this.audio.currentTime=0),o()})["catch"](e=>{console.error(`Failed to load audio file "${t.stimulus}". Try checking the file path. We recommend using the preload plugin to load audio files.`),console.error(e)});const o=()=>{t.trial_ends_after_audio&&this.audio.addEventListener("ended",u),null!==t.prompt&&(e.innerHTML=t.prompt),null!==l?(n=l.currentTime,this.audio.start(n)):this.audio.play(),t.response_allowed_while_playing?d():t.trial_ends_after_audio||this.audio.addEventListener("ended",d),null!==t.trial_duration&&this.jsPsych.pluginAPI.setTimeout(()=>{u()},t.trial_duration),s()},u=()=>{this.jsPsych.pluginAPI.clearAllTimeouts(),null!==l?this.audio.stop():this.audio.pause(),this.audio.removeEventListener("ended",u),this.audio.removeEventListener("ended",d),this.jsPsych.pluginAPI.cancelAllKeyboardResponses();var s={rt:r.rt,stimulus:t.stimulus,response:r.key};e.innerHTML="",this.jsPsych.finishTrial(s),a()},d=()=>{null!==l?this.jsPsych.pluginAPI.getKeyboardResponse({callback_function:i,valid_responses:t.choices,rt_method:"audio",persist:!1,allow_held_key:!1,audio_context:l,audio_context_start_time:n}):this.jsPsych.pluginAPI.getKeyboardResponse({callback_function:i,valid_responses:t.choices,rt_method:"performance",persist:!1,allow_held_key:!1})};return new Promise(e=>{a=e})}simulate(e,t,s,i){"data-only"==t&&(i(),this.simulate_data_only(e,s)),"visual"==t&&this.simulate_visual(e,s,i)}simulate_data_only(e,t){const s=this.create_simulation_data(e,t);this.jsPsych.finishTrial(s)}simulate_visual(e,t,s){const i=this.create_simulation_data(e,t),a=this.jsPsych.getDisplayElement(),n=()=>{null!==i.rt&&this.jsPsych.pluginAPI.pressKey(i.response,i.rt)};this.trial(a,e,()=>{s(),e.response_allowed_while_playing?n():this.audio.addEventListener("ended",n)})}create_simulation_data(e,t){const s={stimulus:e.stimulus,rt:this.jsPsych.randomization.sampleExGaussian(500,50,1/150,!0),response:this.jsPsych.pluginAPI.getValidKey(e.choices)},i=this.jsPsych.pluginAPI.mergeSimulationData(s,t);return this.jsPsych.pluginAPI.ensureSimulationDataConsistency(e,i),i}}return s.info=t,s}(jsPsychModule);