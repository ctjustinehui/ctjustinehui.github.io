var jsPsychHtmlVideoResponse=function(e){"use strict";const t={name:"html-video-response",parameters:{stimulus:{type:e.ParameterType.HTML_STRING,"default":undefined},stimulus_duration:{type:e.ParameterType.INT,"default":null},recording_duration:{type:e.ParameterType.INT,"default":2e3},show_done_button:{type:e.ParameterType.BOOL,"default":!0},done_button_label:{type:e.ParameterType.STRING,"default":"Continue"},record_again_button_label:{type:e.ParameterType.STRING,"default":"Record again"},accept_button_label:{type:e.ParameterType.STRING,"default":"Continue"},allow_playback:{type:e.ParameterType.BOOL,"default":!1},save_video_url:{type:e.ParameterType.BOOL,"default":!1}}};class s{constructor(e){this.jsPsych=e,this.rt=null,this.recorded_data_chunks=[]}trial(e,t){this.recorder=this.jsPsych.pluginAPI.getCameraRecorder(),this.setupRecordingEvents(e,t),this.startRecording()}showDisplay(e,t){let s=`<div id="jspsych-html-video-response-stimulus">${t.stimulus}</div>`;t.show_done_button&&(s+=`<p><button class="jspsych-btn" id="finish-trial">${t.done_button_label}</button></p>`),e.innerHTML=s}hideStimulus(e){const t=e.querySelector("#jspsych-html-video-response-stimulus");t&&(t.style.visibility="hidden")}addButtonEvent(e,t){const s=e.querySelector("#finish-trial");s&&s.addEventListener("click",()=>{const s=performance.now();this.rt=Math.round(s-this.stimulus_start_time),this.stopRecording().then(()=>{t.allow_playback?this.showPlaybackControls(e,t):this.endTrial(e,t)})})}setupRecordingEvents(e,t){this.data_available_handler=(e=>{e.data.size>0&&this.recorded_data_chunks.push(e.data)}),this.stop_event_handler=(()=>{const e=new Blob(this.recorded_data_chunks,{type:this.recorder.mimeType});this.video_url=URL.createObjectURL(e);const t=new FileReader;t.addEventListener("load",()=>{const e=t.result.split(",")[1];this.response=e,this.load_resolver()}),t.readAsDataURL(e)}),this.start_event_handler=(s=>{this.recorded_data_chunks.length=0,this.recorder_start_time=s.timeStamp,this.showDisplay(e,t),this.addButtonEvent(e,t),null!==t.stimulus_duration&&this.jsPsych.pluginAPI.setTimeout(()=>{this.hideStimulus(e)},t.stimulus_duration),null!==t.recording_duration&&this.jsPsych.pluginAPI.setTimeout(()=>{"inactive"!==this.recorder.state&&this.stopRecording().then(()=>{t.allow_playback?this.showPlaybackControls(e,t):this.endTrial(e,t)})},t.recording_duration)}),this.recorder.addEventListener("dataavailable",this.data_available_handler),this.recorder.addEventListener("stop",this.stop_event_handler),this.recorder.addEventListener("start",this.start_event_handler)}startRecording(){this.recorder.start()}stopRecording(){return this.recorder.stop(),new Promise(e=>{this.load_resolver=e})}showPlaybackControls(e,t){e.innerHTML=`\n      <p><video id="playback" src="${this.video_url}" controls></video></p>\n      <button id="record-again" class="jspsych-btn">${t.record_again_button_label}</button>\n      <button id="continue" class="jspsych-btn">${t.accept_button_label}</button>\n    `,e.querySelector("#record-again").addEventListener("click",()=>{URL.revokeObjectURL(this.video_url),this.startRecording()}),e.querySelector("#continue").addEventListener("click",()=>{this.endTrial(e,t)})}endTrial(e,t){this.recorder.removeEventListener("dataavailable",this.data_available_handler),this.recorder.removeEventListener("start",this.start_event_handler),this.recorder.removeEventListener("stop",this.stop_event_handler),this.jsPsych.pluginAPI.clearAllTimeouts();var s={rt:this.rt,stimulus:t.stimulus,response:this.response};t.save_video_url?s.video_url=this.video_url:URL.revokeObjectURL(this.video_url),e.innerHTML="",this.jsPsych.finishTrial(s)}}return s.info=t,s}(jsPsychModule);