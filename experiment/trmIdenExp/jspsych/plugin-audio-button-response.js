var jsPsychAudioButtonResponse=function(e){"use strict";const t={name:"audio-button-response",parameters:{stimulus:{type:e.ParameterType.AUDIO,pretty_name:"Stimulus","default":undefined},choices:{type:e.ParameterType.STRING,pretty_name:"Choices","default":undefined,array:!0},button_html:{type:e.ParameterType.HTML_STRING,pretty_name:"Button HTML","default":'<button class="jspsych-btn">%choice%</button>',array:!0},prompt:{type:e.ParameterType.HTML_STRING,pretty_name:"Prompt","default":null},trial_duration:{type:e.ParameterType.INT,pretty_name:"Trial duration","default":null},margin_vertical:{type:e.ParameterType.STRING,pretty_name:"Margin vertical","default":"0px"},margin_horizontal:{type:e.ParameterType.STRING,pretty_name:"Margin horizontal","default":"8px"},response_ends_trial:{type:e.ParameterType.BOOL,pretty_name:"Response ends trial","default":!0},trial_ends_after_audio:{type:e.ParameterType.BOOL,pretty_name:"Trial ends after audio","default":!1},response_allowed_while_playing:{type:e.ParameterType.BOOL,pretty_name:"Response allowed while playing","default":!0},enable_button_after:{type:e.ParameterType.INT,pretty_name:"Enable button after","default":0}}};class a{constructor(e){this.jsPsych=e}trial(e,t,a){function n(e){var a=performance.now(),n=Math.round(a-u);null!==d&&(a=d.currentTime,n=Math.round(1e3*(a-u))),c.button=parseInt(e),c.rt=n,r(),t.response_ends_trial&&p()}function i(e){n(e.currentTarget.getAttribute("data-choice"))}function r(){for(var e=document.querySelectorAll(".jspsych-audio-button-response-button"),t=0;t<e.length;t++){var a=e[t].querySelector("button");a&&(a.disabled=!0),e[t].removeEventListener("click",i)}}function s(){for(var e=document.querySelectorAll(".jspsych-audio-button-response-button"),t=0;t<e.length;t++){var a=e[t].querySelector("button");a&&(a.disabled=!1),e[t].addEventListener("click",i)}}function o(){t.enable_button_after>0?y(t.enable_button_after):s()}let l;var u,d=this.jsPsych.pluginAPI.audioContext(),c={rt:null,button:null};this.jsPsych.pluginAPI.getAudioBuffer(t.stimulus).then(e=>{null!==d?(this.audio=d.createBufferSource(),this.audio.buffer=e,this.audio.connect(d.destination)):(this.audio=e,this.audio.currentTime=0),h()})["catch"](e=>{console.error(`Failed to load audio file "${t.stimulus}". Try checking the file path. We recommend using the preload plugin to load audio files.`),console.error(e)});const h=()=>{t.trial_ends_after_audio&&this.audio.addEventListener("ended",p),t.response_allowed_while_playing||t.trial_ends_after_audio||this.audio.addEventListener("ended",o);var n=[];if(Array.isArray(t.button_html))t.button_html.length==t.choices.length?n=t.button_html:console.error("Error in audio-button-response plugin. The length of the button_html array does not equal the length of the choices array");else for(var i=0;i<t.choices.length;i++)n.push(t.button_html);var s='<div id="jspsych-audio-button-response-btngroup">';for(i=0;i<t.choices.length;i++){var l=n[i].replace(/%choice%/g,t.choices[i]);s+='<div class="jspsych-audio-button-response-button" style="cursor: pointer; display: inline-block; margin:'+t.margin_vertical+" "+t.margin_horizontal+'" id="jspsych-audio-button-response-button-'+i+'" data-choice="'+i+'">'+l+"</div>"}s+="</div>",null!==t.prompt&&(s+=t.prompt),e.innerHTML=s,t.response_allowed_while_playing?(r(),o()):r(),u=performance.now(),null!==d?(u=d.currentTime,this.audio.start(u)):this.audio.play(),null!==t.trial_duration&&this.jsPsych.pluginAPI.setTimeout(()=>{p()},t.trial_duration),a()},p=()=>{this.jsPsych.pluginAPI.clearAllTimeouts(),null!==d?this.audio.stop():this.audio.pause(),this.audio.removeEventListener("ended",p),this.audio.removeEventListener("ended",o);var a={rt:c.rt,stimulus:t.stimulus,response:c.button};e.innerHTML="",this.jsPsych.finishTrial(a),l()},y=e=>{this.jsPsych.pluginAPI.setTimeout(s,e)};return new Promise(e=>{l=e})}simulate(e,t,a,n){"data-only"==t&&(n(),this.simulate_data_only(e,a)),"visual"==t&&this.simulate_visual(e,a,n)}create_simulation_data(e,t){const a={stimulus:e.stimulus,rt:this.jsPsych.randomization.sampleExGaussian(500,50,1/150,!0)+e.enable_button_after,response:this.jsPsych.randomization.randomInt(0,e.choices.length-1)},n=this.jsPsych.pluginAPI.mergeSimulationData(a,t);return this.jsPsych.pluginAPI.ensureSimulationDataConsistency(e,n),n}simulate_data_only(e,t){const a=this.create_simulation_data(e,t);this.jsPsych.finishTrial(a)}simulate_visual(e,t,a){const n=this.create_simulation_data(e,t),i=this.jsPsych.getDisplayElement(),r=()=>{null!==n.rt&&this.jsPsych.pluginAPI.clickTarget(i.querySelector(`div[data-choice="${n.response}"] button`),n.rt)};this.trial(i,e,()=>{a(),e.response_allowed_while_playing?r():this.audio.addEventListener("ended",r)})}}return a.info=t,a}(jsPsychModule);