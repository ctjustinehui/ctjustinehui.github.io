var jsPsychAnimation=function(e){"use strict";const t={name:"animation",parameters:{stimuli:{type:e.ParameterType.IMAGE,pretty_name:"Stimuli","default":undefined,array:!0},frame_time:{type:e.ParameterType.INT,pretty_name:"Frame time","default":250},frame_isi:{type:e.ParameterType.INT,pretty_name:"Frame gap","default":0},sequence_reps:{type:e.ParameterType.INT,pretty_name:"Sequence repetitions","default":1},choices:{type:e.ParameterType.KEYS,pretty_name:"Choices","default":"ALL_KEYS"},prompt:{type:e.ParameterType.HTML_STRING,pretty_name:"Prompt","default":null},render_on_canvas:{type:e.ParameterType.BOOL,pretty_name:"Render on canvas","default":!0}}};class s{constructor(e){this.jsPsych=e}trial(e,t){var s=t.frame_time+t.frame_isi,i=0,a=0,n=performance.now(),r=[],m=[],l="";if(t.render_on_canvas){if(e.hasChildNodes())for(;e.firstChild;)e.removeChild(e.firstChild);var o=document.createElement("canvas");o.id="jspsych-animation-image",o.style.margin="0",o.style.padding="0",e.insertBefore(o,null);var c=o.getContext("2d")}const u=()=>{this.jsPsych.pluginAPI.cancelKeyboardResponse(_);var e={animation_sequence:r,response:m};this.jsPsych.finishTrial(e)};var p=setInterval(()=>{var s=!0;t.render_on_canvas||(e.innerHTML=""),++i==t.stimuli.length&&(i=0,++a>=t.sequence_reps&&(u(),clearInterval(p),s=!1)),s&&h()},s);const h=()=>{if(t.render_on_canvas){e.querySelector("#jspsych-animation-image").style.visibility="visible";var s=new Image;s.src=t.stimuli[i],o.height=s.naturalHeight,o.width=s.naturalWidth,c.drawImage(s,0,0),null!==t.prompt&&0==i&&0==a&&e.insertAdjacentHTML("beforeend",t.prompt)}else e.innerHTML='<img src="'+t.stimuli[i]+'" id="jspsych-animation-image"></img>',null!==t.prompt&&(e.innerHTML+=t.prompt);l=t.stimuli[i],r.push({stimulus:t.stimuli[i],time:Math.round(performance.now()-n)}),t.frame_isi>0&&this.jsPsych.pluginAPI.setTimeout(()=>{e.querySelector("#jspsych-animation-image").style.visibility="hidden",l="blank",r.push({stimulus:"blank",time:Math.round(performance.now()-n)})},t.frame_time)};var y=t=>{m.push({key_press:t.key,rt:t.rt,stimulus:l}),e.querySelector("#jspsych-animation-image").className+=" responded"},_=this.jsPsych.pluginAPI.getKeyboardResponse({callback_function:y,valid_responses:t.choices,rt_method:"performance",persist:!0,allow_held_key:!1});h()}simulate(e,t,s,i){"data-only"==t&&(i(),this.simulate_data_only(e,s)),"visual"==t&&this.simulate_visual(e,s,i)}create_simulation_data(e,t){const s=[],i=[];let a=0;const n=()=>this.jsPsych.randomization.sampleWithReplacement([!0,!1],1,[1,10])[0];for(let t=0;t<e.sequence_reps;t++)for(const t of e.stimuli)s.push({stimulus:t,time:a}),n()&&i.push({key_press:this.jsPsych.pluginAPI.getValidKey(e.choices),rt:a+this.jsPsych.randomization.randomInt(0,e.frame_time-1),current_stim:t}),a+=e.frame_time,e.frame_isi>0&&(s.push({stimulus:"blank",time:a}),n()&&i.push({key_press:this.jsPsych.pluginAPI.getValidKey(e.choices),rt:a+this.jsPsych.randomization.randomInt(0,e.frame_isi-1),current_stim:"blank"}),a+=e.frame_isi);const r={animation_sequence:s,response:i},m=this.jsPsych.pluginAPI.mergeSimulationData(r,t);return this.jsPsych.pluginAPI.ensureSimulationDataConsistency(e,m),m}simulate_data_only(e,t){const s=this.create_simulation_data(e,t);this.jsPsych.finishTrial(s)}simulate_visual(e,t,s){const i=this.create_simulation_data(e,t),a=this.jsPsych.getDisplayElement();this.trial(a,e),s();for(const e of i.response)this.jsPsych.pluginAPI.pressKey(e.key_press,e.rt)}}return s.info=t,s}(jsPsychModule);