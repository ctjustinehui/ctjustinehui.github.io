<!-- This Program is developed on jsPsych library by Hyoung Seok Kwon & modified by Lisa Sullivan --> 
<!-- Development period: from Oct 26, 2017 to April, 2020 --> 
<!-- library location: jspsych-master/ -->
<!-- PHP file: save_data.php --> 
<!-- result file location and format: data/PARTICIPANTCODEO_result.csv -->
<!-- jsPsych.currentTimelineNodeID bug: cann't get activeID when it is called in jsPsych.init.-->
<!-- Warning: if you provide an array that has very few valid permutations with no neighboring elements, 
     then this method will fail and cause the browser to hang. -->
 
<!DOCTYPE html>
<html>
<head> 
    <meta charset="UTF-8"> 
    <!-- Specify the title of your experiment here. This appears in the browser tab for the user -->
    <title>Linguistics Experiment - First Names & Gender</title> 
    <!-- 	this loads jquery and the main jspsych files. Do not remove (updates to more recent 
    		versions may cause issues)
    -->
    <script src="jquery/jquery-3.2.1.min.js"></script> 
    <script src="jspsych-master/jspsych.js"></script> 
    <!-- Load your plugins here -->
    <script src="jspsych-master/plugins/jspsych-survey-text.js"></script> 
    <!-- Loads the css file with the standard formatting -->
    <link href="jspsych-master/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    
    <!-- Custom CSS to make the experiment look nice -->
    <style type="text/css">
    	.jspsych-btn{margin: 15px;}
    	.jspsych-content-wrapper{width: 80%;}
    	.jspsych-content-wrapper p, h3{text-align: left;}
    	.jspsych-content-wrapper input[type="text"], textarea{width: 100%;}
    	.jspsych-content-wrapper .btn_resp_p, .jspsych-content-wrapper label{text-align: center;}
    	.jspsych-content{width: 100%;}
    </style>
</head>
<body> 
    <div id="jspsych-target"></div>
</body>

<script>

/*******************************************************************************/
/*********************** Define particpant id block ****************************/
/*******************************************************************************/

/** This defines the variable that stores the participant's id, which will be used to
	save their data back to the server
**/

var pID = "";

/** This block contains the form the participant will use to enter their ID
	Add the message you want participants to receive to enter their ID code
	DO NOT push this block to the timeline. check_particpant_id_block will do that
**/    
var participantID = {
    type: 'survey-text',
    preamble: "<h1>Participation Code</h1>",
    questions: [{prompt: "<p>Please enter your participation code. This should have been included in the email you recieved from the investigators.</p>", rows: 1, columns: 80}],
    button_label: "Next",
    on_finish: function(data){
        var responses = JSON.parse(data.responses); 
        jsPsych.data.addProperties({participantID: responses.Q0}); 
        pID = responses.Q0;
    }
};

/**	This block calls the participantID block and checks to make sure a code was entered
	It will assume that anything entered is okay. You could also modifying to check the 
	contents of the code (for example, to make sure it fits the structure of your ID code
	or make sure it only contains certain kinds of characters)
	Push this black to the timeline at the bottom of the file
**/
var check_participant_id_block = {   
	timeline: [participantID],
	loop_function: function(data){
	    var data = jsPsych.data.getLastTrialData().values()[0];
	    var responses = JSON.parse(data.responses);
	    if(responses.Q0==''){
	        alert('Please enter your participation code.'); 
	        return true; 
	    } else {
	    	$('html,body').scrollTop(0);
	        return false; 
	    }
	}
};

/*********************************************************************************/
/************************** User defined functions *******************************/
/*********************************************************************************/


/* save data function */
function saveData(filename, filedata){
    $.ajax({
        type:'post', 
        cache: false, 
        url: 'save_data.php', // this is the path to the above PHP script 
        data: {filename: filename, filedata: filedata} 
    });
};

/** This function is called when the experiment finishes. Add a thank you message, 
	debriefing or direct participants somewhere else (e.g. back to prolific or mturk) 
**/
function finish() {
    DOM_target = document.querySelector('#jspsych-content'); 
    DOM_target.innerHTML ='<p>By clicking next, the participant would continue with the experiment</p>' ; 
    jsPsych.pluginAPI.cancelAllKeyboardResponses(); 
    jsPsych.pluginAPI.clearAllTimeouts();
}; 

/*********************************************************************************/
/******************** Make timeline like flow in Psychopy ************************/
/*********************************************************************************/

/** This creates a variable for the timeline **/

var timeline = [];
/**	List your blocks here in the order you want them to appear
	follow the same format as for the consent block.
**/

timeline = timeline.concat(check_participant_id_block);


/*********************************************************************************/
/******************************** Run jsPsych ************************************/
/*********************************************************************************/

/** This code initiates the experiment and specifies what happens
		- After each trial (on_data_update)
		- At the end of the experiment
**/

jsPsych.init({
    timeline: timeline, 
    show_progress_bar: true, //Defines whether or not the progress bar is shown
    /*on_finish: function(data) {jsPsych.data.displayData('csv')}, */
    on_data_update: function(data) {
        data = jsPsych.data.get(); //updates the data file with the most recent trial
        saveData(pID +'_result.csv', data.csv());  //saves the data to the server; because a participant ID is used, data can be saved after every trial
    },
    on_finish: function(data) {
        data = jsPsych.data.get(); //updates the data file with the most recent trial
        saveData(pID +'_result_en1.csv', data.csv()); //saves the data to the server;
        finish(); //ends the experiment and displays the message in the finish() function above
    }
});

</script>
</html>